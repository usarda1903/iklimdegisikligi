import discord
from discord.ext import commands
from dotenv import load_dotenv
import os
from imageai.Detection import ObjectDetection
import tempfile
import asyncio
from datetime import datetime, timedelta

load_dotenv()

# ImageAI modelini yÃ¼kle
detector = ObjectDetection()
detector.setModelTypeAsYOLOv3()
detector.setModelPath("yolov3.pt")
detector.loadModel()

# Bot ayarlarÄ±
intents = discord.Intents.default()
intents.message_content = True
bot = commands.Bot(command_prefix='!', intents=intents)

# KullanÄ±cÄ± verilerini saklamak iÃ§in basit bir sÃ¶zlÃ¼k
user_data = {}

@bot.event
async def on_ready():
    print(f'{bot.user.name} olarak giriÅŸ yapÄ±ldÄ±!')

@bot.command(name='gorevbaslat', help='Ã‡Ã¶p toplama gÃ¶revini baÅŸlatÄ±r')
async def start_mission(ctx):
    user_id = str(ctx.author.id)
    
    if user_id in user_data and user_data[user_id]['end_time'] > datetime.now():
        remaining = user_data[user_id]['end_time'] - datetime.now()
        hours, remainder = divmod(remaining.seconds, 3600)
        minutes, seconds = divmod(remainder, 60)
        await ctx.send(f"Zaten devam eden bir gÃ¶reviniz var! Kalan sÃ¼re: {hours} saat {minutes} dakika")
        return
    
    user_data[user_id] = {
        'collected': 0,
        'start_time': datetime.now(),
        'end_time': datetime.now() + timedelta(hours=24)
    }
    
    embed = discord.Embed(
        title="Ã‡Ã¶p Toplama GÃ¶revi BaÅŸladÄ±!",
        description="24 saat iÃ§inde 10 adet Ã§Ã¶p fotoÄŸrafÄ± gÃ¶nderin!",
        color=discord.Color.green()
    )
    embed.add_field(name="Komut", value="!fotografyukle komutuyla fotoÄŸraf gÃ¶nderin")
    await ctx.send(embed=embed)

@bot.command(name='fotografyukle', help='Ã‡Ã¶p fotoÄŸrafÄ± yÃ¼kler')
async def upload_photo(ctx):
    user_id = str(ctx.author.id)
    
    # GÃ¶rev kontrolÃ¼
    if user_id not in user_data or user_data[user_id]['end_time'] < datetime.now():
        await ctx.send("Ã–nce !gorevbaslat komutuyla gÃ¶rev baÅŸlatmalÄ±sÄ±nÄ±z!")
        return
    
    # FotoÄŸraf kontrolÃ¼
    if not ctx.message.attachments:
        await ctx.send("LÃ¼tfen bir fotoÄŸraf ekleyin!")
        return
    
    attachment = ctx.message.attachments[0]
    if not attachment.filename.lower().endswith(('.png', '.jpg', '.jpeg')):
        await ctx.send("Sadece PNG veya JPG formatÄ±nda fotoÄŸraf yÃ¼kleyebilirsiniz!")
        return
    
    # FotoÄŸrafÄ± indir
    temp_file = tempfile.NamedTemporaryFile(delete=False, suffix=".jpg")
    await attachment.save(temp_file.name)
    
    # FotoÄŸrafÄ± analiz et
    await ctx.send("FotoÄŸraf analiz ediliyor...")
    
    detections = detector.detectObjectsFromImage(
        input_image=temp_file.name,
        minimum_percentage_probability=30
    )
    
    # Ã‡Ã¶p olup olmadÄ±ÄŸÄ±nÄ± kontrol et
    trash_objects = ['bottle', 'can', 'wrapper', 'trash', 'garbage', 'plastic']
    is_trash = any(obj['name'].lower() in trash_objects for obj in detections)
    
    if is_trash:
        user_data[user_id]['collected'] += 1
        collected = user_data[user_id]['collected']
        
        if collected >= 10:
            # GÃ¶rev tamamlandÄ±
            embed = discord.Embed(
                title="Tebrikler! ğŸ‰",
                description="10 Ã§Ã¶p toplama gÃ¶revini tamamladÄ±nÄ±z!",
                color=discord.Color.gold()
            )
            await ctx.send(embed=embed)
        else:
            # Ä°lerleme gÃ¶ster
            embed = discord.Embed(
                title="Ã‡Ã¶p Tespit Edildi!",
                description=f"Toplanan Ã§Ã¶p: {collected}/10",
                color=discord.Color.blue()
            )
            await ctx.send(embed=embed)
    else:
        await ctx.send("Bu bir Ã§Ã¶p deÄŸil gibi gÃ¶rÃ¼nÃ¼yor. LÃ¼tfen Ã§Ã¶p fotoÄŸrafÄ± yÃ¼kleyin!")

    # GeÃ§ici dosyayÄ± sil
    temp_file.close()
    os.unlink(temp_file.name)

@bot.command(name='durum', help='GÃ¶rev durumunu gÃ¶sterir')
async def show_status(ctx):
    user_id = str(ctx.author.id)
    
    if user_id not in user_data or user_data[user_id]['end_time'] < datetime.now():
        await ctx.send("Aktif bir gÃ¶reviniz yok. !gorevbaslat komutuyla baÅŸlatabilirsiniz.")
        return
    
    collected = user_data[user_id]['collected']
    end_time = user_data[user_id]['end_time']
    remaining = end_time - datetime.now()
    
    hours, remainder = divmod(remaining.seconds, 3600)
    minutes, seconds = divmod(remainder, 60)
    
    embed = discord.Embed(
        title="GÃ¶rev Durumu",
        color=discord.Color.orange()
    )
    embed.add_field(name="Toplanan Ã‡Ã¶p", value=f"{collected}/10", inline=True)
    embed.add_field(name="Kalan SÃ¼re", value=f"{hours} saat {minutes} dakika", inline=True)
    
    await ctx.send(embed=embed)

bot.run(os.getenv('MTM1NjIyMTkwMzQ3NTQ0NTk3Mg.GYA2Ui._R3mbE9LSlkw5ET1EdcV5GFcvVabY_RLxlgKvk'))
